        /* --- 1. IMPOSTAZIONI TEMA --- */
:root {
    /* Colori Base (Definisci solo questi) */
    --colore-primario: #007bff;
    --colore-pericolo: #d9534f;
    --colore-successo: #5cb85c;
    --colore-warning: #f0ad4e;
    --colore-info: #5bc0de;
    
    /* Colori RGB (per trasparenze) */
    --colore-primario-rgb: 0, 123, 255;
    
    /* Colori Derivati (Generati automaticamente) */
    --colore-primario-hover: color-mix(in srgb, var(--colore-primario) 80%, black);
    --colore-pericolo-hover: color-mix(in srgb, var(--colore-pericolo) 80%, black);
    --colore-successo-hover: color-mix(in srgb, var(--colore-successo) 80%, black);
    --colore-warning-hover: color-mix(in srgb, var(--colore-warning) 80%, black);
    --colore-info-hover: color-mix(in srgb, var(--colore-info) 80%, black);

    /* Tema Chiaro */
    --colore-sfondo: #f4f4f4;
    --colore-testo: #1c1c1e;
    --colore-sfondo-widget: #fff;
    --colore-bordo: #e0e0e0;
    --colore-sfondo-chatbox: #fff;
    --colore-mio-messaggio: #dcf8c6;
    --colore-altri-messaggi: #f0f0f0;
    --colore-tiro-dado: #fffde7;
    --colore-bordo-tiro: #c0c09d;
    --colore-pin: #ffe8cc;
    --colore-privato: #f0ad4e;
    --colore-gm: #9b59b6;
    --colore-turno-corrente: rgba(var(--colore-primario-rgb), 0.1);
    --shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    --grid-color: rgba(0, 0, 0, 0.2);
    --ping-color: rgba(255, 0, 0, 0.7);
    --measure-color: var(--colore-primario);
    --colore-sfondo-input: var(--colore-sfondo);
    --colore-bordo-input: var(--colore-bordo);
    --colore-roll-result: #00008B;
}

body.dark-mode {
    --colore-sfondo: #1c1c1e;
    --colore-testo: #f2f2f7;
    --colore-sfondo-widget: #2c2c2e;
    --colore-bordo: #3a3a3c;
    --colore-sfondo-chatbox: #2c2c2e;
    --colore-mio-messaggio: #005025;
    --colore-altri-messaggi: #3a3a3c;
    --colore-tiro-dado: #3a3a00;
    --colore-bordo-tiro: #898900;
    --colore-pin: #4d3300;
    --colore-turno-corrente: rgba(var(--colore-primario-rgb), 0.2);
    --shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    --grid-color: rgba(255, 255, 255, 0.2);
    --colore-sfondo-input: #333;
    --colore-bordo-input: #444;
    --colore-roll-result: #89cff0;
}


/* --- 2. STILI GENERALI --- */

* {
    box-sizing: border-box;
}

body {
    height: 100vh;
    max-height: 100vh;
    margin: 0;
    padding: clamp(10px, 2vw, 20px); /* Spaziatura fluida */
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-size: clamp(14.5px, 1.2vw, 16px); /* Tipografia fluida */
    color: var(--colore-testo);
    background-color: var(--colore-sfondo);
    transition: background-color 0.2s, color 0.2s;
}

.widget {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    padding: 15px;
    background-color: var(--colore-sfondo-widget);
    border: 1px solid var(--colore-bordo);
    border-radius: 6px;
    box-shadow: var(--shadow);

    /* Spaziatura automatica tra gli elementi del widget */
    gap: 10px; 

    h3 {
        margin-block-start: 0;
        margin-block-end: 5px; /* Spazio extra dopo h3 */
        padding-block-end: 5px;
        border-block-end: 1px solid var(--colore-bordo);
        font-size: 1.1rem;
        font-weight: 600;
    }

    h4 {
        margin: 10px 0 5px 0; /* Margine ridotto, gap gestisce lo spazio */
        padding-block-start: 10px;
        border-block-start: 1px solid var(--colore-bordo);
        font-size: 0.95rem;
        font-weight: 600;
        opacity: 0.8;
    }
}

/* --- Elementi Form --- */

button {
    display: inline-flex;
    align-items: center;
    justify-content: center; /* Centra icona/testo */
    gap: 5px;
    padding: 8px 12px;
    font-size: 0.95rem;
    font-weight: 600;
    color: white;
    background-color: var(--colore-primario);
    border: none;
    border-radius: 6px;
    white-space: nowrap;
    cursor: pointer;
    transition: background-color 0.2s;

    &:hover {
        background-color: var(--colore-primario-hover);
    }

    &:disabled {
        background-color: #aaa;
        cursor: default;
    }

    &:focus-visible {
        outline: 2px solid var(--colore-primario-hover);
        outline-offset: 2px;
    }
}

.admin-button {
    background-color: var(--colore-pericolo);

    &:hover {
        background-color: var(--colore-pericolo-hover);
    }
}

input,
select,
textarea {
    width: 100%;
    padding: 8px 10px;
    font-family: inherit;
    font-size: 0.95rem;
    color: var(--colore-testo);
    background-color: var(--colore-sfondo-input);
    border: 1px solid var(--colore-bordo-input);
    border-radius: 6px;
    transition: background-color 0.2s, border-color 0.2s;

    &:focus-visible {
        border-color: var(--colore-primario);
        outline: 2px solid var(--colore-primario);
    }
}

textarea {
    min-height: 100px;
    resize: vertical;
}

input[type="number"] {
    width: 60px;
    text-align: end;
}

input[type="color"] {
    width: 40px;
    height: 36px;
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
}

input[type="checkbox"] {
    width: auto;
}

label {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

.input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;

    input[type="text"],
    input[type="url"],
    select {
        flex-grow: 1;
        /* Assicura che gli input non diventino troppo piccoli */
        min-width: 50px; 
    }

    label {
        font-size: 0.9rem;
        white-space: nowrap;
    }

    /* Stile per i bottoni dentro ai gruppi */
    button {
        flex-shrink: 0;
    }
}

/* --- Layout Utility --- */

.button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;

    &.full-width button {
        grid-column: 1 / -1;
    }
}

.button-group-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
}

.icon-text {
    font-size: 1.1em;
    line-height: 1;
}


/* --- 3. LAYOUT PRINCIPALE --- */

.app-container#main-content {
    display: grid;
    grid-template-columns: 320px 1fr 400px;
    gap: 20px;
    width: 100%;
    height: 100%;
    max-width: 1800px;
    max-height: calc(100vh - (clamp(10px, 2vw, 20px) * 2)); /* Padding fluido */
    margin: 0 auto;
}

.vtt-column,
.main-column,
.sidebar-column {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-width: 0;
    overflow: hidden;
    /* Spazio tra i widget in una colonna */
    gap: 20px; 
}

/* --- VTT --- */

#vtt-container {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: var(--colore-sfondo-widget);
    border: 1px solid var(--colore-bordo);
    border-radius: 6px;
    box-shadow: var(--shadow);
    cursor: default;

    &.drawing,
    &.measuring {
        cursor: crosshair;
    }
    &.pinging {
        cursor: pointer;
    }
}

/* --- Colonna Principale (Chat) --- */

#name-area {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
}

#request-gm-btn {
    display: none; /* Gestito da JS */
    background-color: var(--colore-warning);
    width: 100%; /* Da HTML */

    &:hover {
        background-color: var(--colore-warning-hover);
    }
}

#presence-widget {
    flex-shrink: 0;
    padding: 10px 15px;
    display: none; /* Nascosto di default, mostrato da JS */
}

#presence-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    max-height: 70px;
    overflow-y: auto;
}

.user-pill {
    display: inline-flex;
    flex-shrink: 0;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    font-size: 0.9rem;
    font-weight: 500;
    background-color: var(--colore-altri-messaggi);
    border: 2px solid;
    border-radius: 16px;

    .gm-badge {
        padding: 1px 4px;
        font-size: 0.75rem;
        font-weight: bold;
        color: #fff;
        background-color: var(--colore-pericolo);
        border-radius: 4px;
    }
}

#pinned-message-bar {
    display: none; /* Mostrato via JS */
    position: relative;
    flex-shrink: 0;
    align-items: center; /* Centra verticalmente testo e bottone */
    padding: 10px 40px 10px 15px; /* Pi√π spazio per il bottone */
    background-color: var(--colore-pin);
    border: 1px solid var(--colore-bordo-tiro);
    border-radius: 8px;
}

#unpin-button {
    position: absolute;
    top: 50%;
    inset-inline-end: 10px;
    padding: 0;
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--colore-pericolo);
    background: none;
    border: none;
    transform: translateY(-50%);
    cursor: pointer;
    width: 28px; /* Dimensione fissa per il bottone icona */
    height: 28px;
}

#chatbox {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    gap: 2px;
    min-height: 0;
    padding: 10px;
    overflow-y: scroll;
    background-color: var(--colore-sfondo-chatbox);
    border: 1px solid var(--colore-bordo);
    border-radius: 8px;
    box-shadow: var(--shadow);
    transition: background-color 0.2s;
}

.message-bubble {
    position: relative;
    align-self: flex-start;
    max-width: 85%;
    margin-block-start: 6px;
    padding: 6px 12px;
    font-style: normal;
    background-color: var(--colore-altri-messaggi);
    border-radius: 10px;
    word-wrap: break-word;
    overflow-wrap: break-word;

    &.mine {
        align-self: flex-end;
        background-color: var(--colore-mio-messaggio);
    }

    &.grouped {
        margin-block-start: 2px;

        .nome-utente {
            display: none;
        }
    }

    &.roll-message {
        background-color: var(--colore-tiro-dado);
        border: 1px dashed var(--colore-bordo-tiro);
    }

    &.mine.roll-message {
        background-color: var(--colore-mio-messaggio);
    }

    &.private-message {
        font-style: italic;
        border-inline-start: 3px solid var(--colore-privato);
    }

    &.mine.private-message {
        border-inline-start: none;
        border-inline-end: 3px solid var(--colore-privato);
    }

    &.gm-message {
        font-style: italic;
        border-inline-start: 3px solid var(--colore-gm);
    }

    &.mine.gm-message {
        border-inline-start: none;
        border-inline-end: 3px solid var(--colore-gm);
    }

    .message-timestamp {
        display: block;
        margin-block-start: 4px;
        font-size: 0.7rem;
        text-align: end;
        opacity: 0.6;
    }

    &.mine .message-timestamp {
        text-align: start;
    }
}

.nome-utente {
    display: block;
    padding-block-end: 2px;
    font-size: 0.9rem;
    font-weight: 600;
}

.message-content {
    strong { font-weight: bold; }
    em { font-style: italic; }
    del { text-decoration: line-through; }
    a { color: var(--colore-primario); text-decoration: underline; }
    ul, ol { margin: 5px 0 5px 20px; padding: 0; }
    li { margin-block-end: 3px; }
}

.roll-result {
    font-weight: bold;
    color: var(--colore-roll-result);
}

.pin-button {
    display: none; /* Mostrato on hover */
    position: absolute;
    top: 2px;
    inset-inline-end: 8px;
    padding: 2px 4px;
    font-size: 10px;
    background: #aaa;
    border-radius: 4px;
    cursor: pointer;
}

.gm-is-me .message-bubble.public-message:hover .pin-button {
    display: block;
}

/* --- Controlli Chat --- */

#controls-area {
    /* Eredita gap: 10px da .widget */
    padding: 15px;
}

#visibility-controls {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    gap: 8px;

    label {
        font-size: 0.8rem;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    input[type="radio"] {
        display: none;

        & + span {
            display: block;
            padding: 4px 10px;
            background-color: var(--colore-altri-messaggi);
            border-radius: 20px;
        }

        &:checked + span {
            font-weight: 600;
            color: white;
            background-color: var(--colore-primario);
        }
    }
}

#dice-builder {
    span { 
        font-weight: 500;
        font-size: 1.1em;
    }
    input[type="number"] {
        width: 50px;
        flex-grow: 0;
    }
    select {
        flex-grow: 1;
    }
}

/* --- 4. SIDEBAR (Widget Strumenti) --- */

#tools-widget {
    display: none; /* Mostrato via JS */
    flex-grow: 1;
    min-height: 0;
    padding: 0;
    overflow: hidden;
    gap: 0; /* Sovrascrive il gap di .widget */
}

/* Navigazione Tab */
.tab-nav {
    display: flex;
    flex-shrink: 0;
    overflow-x: auto;
    background-color: var(--colore-sfondo);
    border-block-end: 1px solid var(--colore-bordo);
}

.tab-button {
    flex-grow: 1;
    flex-shrink: 0;
    padding: 10px 15px;
    font-size: 1.1rem; /* Icone pi√π grandi */
    font-weight: 500;
    color: var(--colore-testo);
    background: none;
    border: none;
    border-radius: 0;
    opacity: 0.6;

    &.active {
        font-weight: 600;
        color: var(--colore-testo);
        background-color: var(--colore-sfondo-widget);
        border-block-start: 2px solid var(--colore-primario);
        opacity: 1;
    }
}

#tab-btn-admin {
    display: none;
}
.gm-is-me #tab-btn-admin {
    display: flex;
}

/* Contenuto Tab */
.tab-content {
    flex-grow: 1;
    min-height: 0;
    padding: 15px;
    overflow-y: auto;
}

.tab-pane {
    display: none;
    flex-direction: column;
    gap: 15px; /* Spazio tra gli elementi in un tab */
    height: 100%;

    &.active {
        display: flex;
    }
}

/* --- Tab 1: Ordine di Turno --- */

#gm-turn-controls {
    display: none; /* Nascosto di default */
    flex-direction: column;
    gap: 10px; /* Sostituisce margin-top inline */
    margin-block-start: 15px;
    padding-block-start: 15px;
    border-block-start: 1px solid var(--colore-bordo);
}
.gm-is-me #gm-turn-controls {
    display: flex; /* Mostrato per i GM */
}

/* Stili per bottoni Turno */
#next-turn-btn {
    background-color: var(--colore-successo);
    &:hover { background-color: var(--colore-successo-hover); }
}
#reset-values-btn {
    background-color: var(--colore-pericolo);
    &:hover { background-color: var(--colore-pericolo-hover); }
}
#reset-turn-btn {
    background-color: var(--colore-warning);
    grid-column: 1 / -1; /* Sostituisce stile inline */
    &:hover { background-color: var(--colore-warning-hover); }
}


#turn-order-list {
    flex-grow: 1;
    height: 100px;
    margin: 0;
    padding-inline-start: 0;
    list-style-type: none;
    overflow-y: auto;

    li {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 8px 5px;
        border-block-end: 1px solid var(--colore-bordo);
        transition: background-color 0.2s;

        &:last-child {
            border-block-end: none;
        }

        &.current-turn {
            padding-inline-start: 2px;
            background-color: var(--colore-turno-corrente);
            border-inline-start: 3px solid var(--colore-primario);
        }
    }
}

.turn-participant-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow: hidden;
}

.turn-name {
    overflow: hidden;
    font-size: 1rem;
    font-weight: 600;
    white-space: nowrap;
    text-overflow: ellipsis;
}

.turn-details {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    opacity: 0.7;
}

.turn-hp input,
.turn-status input {
    height: 24px;
    padding: 2px 4px;
    font-size: 0.8rem;
}
.turn-hp input { width: 45px; }
.turn-status input { width: 80px; }

.turn-controls {
    display: flex;
    flex-shrink: 0;
    align-items: center;
    gap: 5px;
}

.turn-value-edit {
    width: 50px;
    height: 28px;
    padding: 2px 5px;
    font-size: 1rem;
    font-weight: bold;
    text-align: end;
}

.turn-value-display {
    min-width: 30px;
    padding: 0 5px;
    font-size: 1.1rem;
    font-weight: bold;
    text-align: end;
}

.turn-delete-btn {
    height: 28px;
    padding: 2px 5px;
    font-size: 0.8rem;
    background: var(--colore-pericolo);
    border-radius: 4px;
}

/* --- Tab 3: Macro --- */
#add-macro-group {
    /* Sostituisce stile inline */
    margin-block-start: 10px;
    padding-block-start: 15px;
    border-block-start: 1px solid var(--colore-bordo);
}

#macro-list {
    margin: 0;
    padding: 0;
    list-style: none;

    li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 5px 0;
        border-block-end: 1px solid var(--colore-bordo);

        &:last-child {
            border: none;
        }
    }
}

.macro-details { overflow: hidden; }
.macro-name { font-weight: 600; }
.macro-command {
    display: block;
    overflow: hidden;
    font-family: monospace;
    font-size: 0.85rem;
    white-space: nowrap;
    text-overflow: ellipsis;
    opacity: 0.7;
}
.delete-macro-btn {
    flex-shrink: 0;
    padding: 2px 6px;
    font-size: 0.8rem;
    background: var(--colore-pericolo);
}

/* --- Tab 4: Note --- */
.notes-controls {
    display: flex;
    align-items: center;
    gap: 10px;

    select { flex-grow: 1; }
    button { flex-shrink: 0; }
}

.note-delete-btn {
    background-color: var(--colore-pericolo);
}

#notes-textarea {
    flex-grow: 1;
    height: 100%;
}

/* --- Tab 6: Controlli VTT (Griglia) --- */
.vtt-controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    align-items: start;
}

.vtt-control-section {
    display: flex;
    flex-direction: column;
    gap: 10px; /* Spazio tra gli elementi, sostituisce margin-top */

    h4 {
        margin: 0 0 5px 0;
        padding-block-end: 5px;
        font-size: 0.95rem;
        font-weight: 600;
        border-block-start: none;
        border-block-end: 1px solid var(--colore-bordo);
        opacity: 0.8;
    }

    .input-group {
        flex-wrap: wrap;
        gap: 5px 10px;
        align-items: center;

        label {
            flex-basis: 60px;
            flex-shrink: 0;
            font-size: 0.85rem;
        }
    }
    
    small {
        font-size: 0.8em;
        opacity: 0.8;
    }
}

.tool-selection-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;

    label {
        font-size: 0.85rem;
    }
}

/* Override per input piccoli */
#drawing-stroke-width,
#grid-scale {
    flex-grow: 0;
    width: 60px;
}
#grid-unit {
    flex-grow: 0;
    width: 50px;
}
#vtt-token-color {
    flex-grow: 0;
}

.vtt-control-section.gm-only { display: none; }
.gm-is-me .vtt-control-section.gm-only { display: flex; }

/* --- Tab 7: Admin VTT --- */
#admin-music-title {
    margin-block-start: 0; /* Sostituisce stile inline */
    margin-block-end: 5px;
    padding-block-start: 0;
    border-block-start: none;
    font-size: 0.95rem;
    font-weight: 600;
    opacity: 0.8;
}

#theme-toggle,
#clear-local-btn {
    width: 100%; /* Da HTML */
}

/* --- 5. MODALI --- */
#gm-request-modal {
    display: none; /* Mostrato via JS */
    position: fixed;
    z-index: 1000;
    inset: 0;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
}

#gm-request-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 20px;
    color: var(--colore-testo);
    background-color: var(--colore-sfondo-widget);
    border: 1px solid var(--colore-bordo);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    text-align: center;

    p {
        margin: 0;
    }
    button {
        margin: 0 5px;
    }
}

#gm-accept {
    background-color: var(--colore-successo);
    &:hover { background-color: var(--colore-successo-hover); }
}
#gm-refuse {
    background-color: var(--colore-pericolo);
    &:hover { background-color: var(--colore-pericolo-hover); }
}


/* --- 6. MEDIA QUERIES --- */
@media (max-width: 1200px) {
    .app-container#main-content {
        grid-template-columns: 320px 1fr;
    }
    .vtt-column { display: none; }
}

@media (max-width: 900px) {
    body {
        height: auto;
        max-height: none;
        overflow-y: auto;
    }
    .app-container#main-content {
        grid-template-columns: 1fr;
        height: auto;
        max-height: none;
    }
    .sidebar-column { grid-row: 1; height: auto; }
    .main-column { grid-row: 2; height: auto; overflow: visible; }
    .vtt-column { display: none; }
}


#login-widget {
    display: flex; /* Visibile di default */
}
#tools-widget,
#presence-widget,
#gm-turn-controls,
.gm-only {
    display: none; /* Nascosti di default */
}
.gm-is-me #tab-btn-admin,
.gm-is-me .vtt-control-section.gm-only {
    display: flex; /* Gi√† presente, ma usiamo la classe 'is-gm' */
}


/* NUOVE REGOLE DI STATO */

/* Quando l'utente √® loggato */
body.is-logged-in #login-widget {
    display: none; /* Nascondi login */
}
body.is-logged-in #tools-widget,
body.is-logged-in #presence-widget {
    display: flex; /* Mostra strumenti e presenza */
}

/* Quando l'utente √® il GM (oltre a essere loggato) */
body.is-gm #gm-turn-controls {
    display: flex; /* Mostra controlli GM */
}
body.is-gm .gm-only {
    display: flex; /* Mostra tutte le sezioni .gm-only */
}
body.is-gm #tab-btn-admin {
    display: flex; /* Mostra tab admin */
}

/* Per il modale (puoi usare la stessa logica) */
#gm-request-modal {
    display: none; /* Gi√† presente */
}
#gm-request-modal.is-visible {
    display: flex; /* Mostra il modale */
}